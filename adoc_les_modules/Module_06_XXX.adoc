= JavaScrit
include::./../adoc_fragments/fragment_header.adoc[]

Module 06 - Stockage des donn√©es

ifeval::["{formateur}" ==  "yes"]
[NOTE.speaker]
.Discours formateur
****
Bienvenue dans ce module traitant du stockage des donn√©es sur un navigateur.
****
endif::[]

== Objectifs

 * Conna√Ætre les diff√©rents fa√ßon de stocker des donn√©es c√¥t√© client
 * Savoir manipuler les cookies avec Javascript
 * Savoir manipuler le local storage
 * Savoir manipuler le session storage
 * Savoir bien choisir entre cookies/local ou session storage
 * Savoir utiliser JSON

== Les cookies c'est quoi ?

Un cookie est un petit fichier stock√© sur le navigateur de l'utilisateur et associ√© √† un domaine web. Ce fichier est automatiquement renvoy√© lors de contacts ult√©rieurs avec le m√™me domaine.

== Usage des cookies

* Couple cl√©/valeur
* 4 ko maximum
* Stock√© sur le navigateur
* Dur√©e de vie al√©atoire

[NOTE.speaker]
****
Les cookies ont de multiples usages : ils peuvent servir √† m√©moriser votre identifiant client aupr√®s d'un site marchand, le contenu courant de votre panier d'achat, la langue d‚Äôaffichage de la page web, un identifiant permettant de tracer votre navigation √† des fins statistiques ou publicitaires, etc. Certains de ces usages sont strictement n√©cessaires aux fonctionnalit√©s express√©ment demand√©es par l‚Äôutilisateur ou bien √† l‚Äô√©tablissement de la communication et donc exempt√©s de consentement. D‚Äôautres, qui ne correspondent pas √† ces crit√®res, n√©cessitent un consentement de l‚Äôutilisateur avant lecture ou √©criture.
****

[background-color="#F4D03F"]
== D√©monstration
Allez voir ses cookies sur son navigateur

== Les cookies : Cr√©ation via un serveur

image::images/cookies_1.drawio.png[]

== Les cookies : Cr√©ation via un serveur

image::images/cookies_2.drawio.png[]

== Les cookies : Cr√©ation via un programme JavaSCript

image::images/cookies_3.drawio.png[]

== Les cookies : Cr√©er un cookie en JavaScript

[source,javascript]
----
// document.cookie = 'cle=valeur';
// ajoute un cookie avec la cl√© lang et la valeur fran√ßais
document.cookie = 'lang=fran√ßais';
----

[background-color="#F4D03F"]
== D√©monstration
Cr√©ation d'un cookie en JavaScript

== Les cookies : Lire un cookie en JavaScript

[source,javascript]
----
console.log(document.cookie); // donne toute la grande String contenant tous les cookie

// pour lire un cookie il faut "un peu" de logique
const cookiesAsArray = document.cookie.split('; ');
// on parcourt le tableau
for (const cookie of cookiesAsArray) {
    // si la cha√Æne commence par le d√©but du cookie qui nous int√©resse
    if (cookie.startsWith('nomDuCookieRecherch√©')) {
        // on d√©coupe le contenu du cookie
        const cookieInfo = cookie.split('=');
        // pour r√©cup√©rer que la valeur
        const value = cookieInfo[1];
        // la valeur est trouv√©e
        console.log(value);
    }
}
----

[background-color="#F4D03F"]
== D√©monstration
Lecture d'un cookie en JavaScript

== Local Storage c'est quoi ?

* Li√© au domaine qui fait tourner notre application, on ne peut pas r√©cup√©rer des infos qui auraient √©t√© mises de cot√© sur Facebook alors qu'on est sur Youtube
* Plus pratique √† utiliser que les cookies
* üö´Les informations du localStorage ne sont pas incluses dans les requ√™tes HTTP
* Pas de limite de conservation des donn√©es

== Local Storage : Ecrire des donn√©es

[source,javascript]
----
// l'objet localStorage est global, il est toujours disponible :
// - via la m√©thode setItem on sauvegarde une information, m√™me si je quitte la page et que je reviens, l'information est persistante
// - on passe 2 arguments, la cl√© pour retrouver la valeur plus tard, et la valeur
localStorage.setItem('age', 31);
----

[background-color="#F4D03F"]
== D√©monstration
LocalStorage : Ecrire des donn√©es avec JavaScript

== LocalStorage : Lire les donn√©es

[source,javascript]
----
// via la m√©thode getItem, on r√©cup√®re la valeur, il faut passer la cl√© en argument
const userAge = localStorage.getItem('age');
console.log(userAge); // '31'
----

[background-color="#F4D03F"]
== D√©monstration
LocalStorage : Lire des donn√©es avec JavaScript

== Le localStorage ne g√®re que des String

Si on veut stocker n'importe quel type de donn√©es (un objet, un tableau, un bool√©en, ...), on peut le transformer en String via :

[source,javascript]
----
const valeurATransformer = true;
JSON.stringify(valeurATransformer);
----

[background-color="#F4D03F"]
== D√©monstration
Transformer des donn√©es en String

== JSON c'est quoi ?

Le JSON (JavaScript Object Notation) est un format de donn√©es textuelles d√©riv√© de la notation des objets du langage JavaScript. Comme c'est du texte, on peut donc le stocker dans le localStorage üòé

== SessionStorage c'est quoi ?

SessionStorage fonctionne de la m√™me mani√®re que LocalStorage mise √† part que les donn√©es du sessionStorage ont une dur√©e de vie limit√© √† la session de navigation. Si on ferme le navigateur, les donn√©es sont effac√©es.

== Session Storage : La syntaxe

* On pourra donc :
    ** ajouter/modifier une information

[source,javascript]
----
sessionStorage.setItem('key','value');
----

    ** r√©cup√©rer une information

[source,javascript]
----
sessionStorage.getItem('key');
----

** supprimer une information

[source,javascript]
----
sessionStorage.removeItem('key');
----

** supprimer toutes les informations

[source,javascript]
----
sessionStorage.clear();
----

[background-color="#F4D03F"]
== D√©monstration
Utilisation de SessionStorage

[background-color="#5DADE2"]
== A toi de jouer
Sur Trip'Odvisor, quel m√©thodologie utiliserais tu pour sauvegarder l'activiation du dark mode ?

== R√©sultat de la r√©flexion

* R√©sultat de la r√©flexion :
   ** cookie, non, car pas besoin d'envoyer ce choix dans chaque requ√™te HTTP (pas utile c√¥t√© serveur)
   ** sessionStorage, non, car on veut conserver la pr√©f√©rence de l'utilisateur m√™me s'il ferme son navigateur
   ** on part donc sur le localStorage üëå

[background-color="#F4D03F"]
== D√©monstration
Sur Trip'Odvisor

Code
JSON, localStorage, objets, m√©thodes, DOM lecture/√©criture, √©v√®nements, classList, conditions

On ajoute la m√©thode saveToLocalStorage qui sauvegarde l'√©tat du th√®me dans le localStorage
On appelle cette m√©thode apr√®s avoir chang√© le th√®me dans toggleDark
On cr√©e la m√©thode initLocalState qui v√©rifie le th√®me sauvegard√© et on l'appelle au chargement de la page dans init
‚ÑπÔ∏è Montrer le contenu du localStorage via les Devtools/Application/Storage/LocalStorage.

‚ö†Ô∏è Comme on utilise le domaine localhost, il y aura d'autres valeurs pr√©sentes dans le localStorage et pas seulement celles de notre site. Pr√©ciser qu'en production, on aurait notre propre nom de de domaine et qu'on ne rencontrerait pas ce probl√®me.

//const theme = {
//
//    init: function() {*/
//
//        // On s√©lectionne le bouton de changement de th√®me
//        const themeSwitchElement = document.querySelector('#theme-switch');
//
//        // On place un √©couteur d'√©v√©nement sur le bouton
//        themeSwitchElement.addEventListener('click', theme.toggleDark);
//
//        // Au chargement de la page, on v√©rifie si le localStorage contient une valeur pour le theme sombre/clair
//        theme.initLocalState();
//
//    },
//
//    toggleDark() {
//
//        // On commence par s√©lectionner la balise sur laquelle
//        // on va modifier la classe "theme-dark"
//        const body = document.querySelector('body');
//
//        body.classList.toggle('theme-dark');
//
//        // On sauvegarde le th√®me dans le localStorage
//        theme.saveToLocalStorage();
//
//    },
//
//    saveToLocalStorage: function() {
//
//        // On v√©rifie si le body contient le theme dark
//        // contains renvoie true si la classe est pr√©sente, false sinon.
//        const isDark = document.body.classList.contains('theme-dark');
//
//        // On transforme la valeur bool√©enne en cha√Æne de caract√®res
//        const newLocalSave = JSON.stringify(isDark);
//
//        // On sauvegarde le theme dans le localStorage
//        localStorage.setItem('darkMode', newLocalSave);
//
//    },
//
//    initLocalState: function() {
//
//        // On r√©cup√®re la valeur du th√®me dans le localStorage
//        const localSave = localStorage.getItem('darkMode');
//
//        // On transforme la cha√Æne de caract√®res en bool√©en
//        const isDark = JSON.parse(localSave);
//
//        // Si "isDark" contient true, c'est que le th√®me est en mode dark
//        if (isDark) {
//            // On applique le th√®me dark
//            document.body.classList.add('theme-dark');
//        }
//
//    }
//};
//
//document.addEventListener('DOMContentLoaded', theme.init);*/

== Conclusion
* Vous connaissez les diff√©rentes m√©thodologies de sauvegarde de donn√©es sur un navigateur
* Vous savez cr√©er et lire des cookies en JavaScript
* Vous savez cr√©er et lire dans le LocalStorage de votre navigateur en JavaScript
* Vous savez cr√©er et lire dans le SessionStorage de votre navigateur en JavaScript

== Objectif / Niveau
* *Essentiel* : Comprendre le fonctionnement de tous les m√©canismes de persistance c√¥t√© client.
* *Attendu* : Savoir utiliser tous les m√©canismes de persistance c√¥t√© client.
* *Avanc√©* : Savoir choisir le meilleur m√©canisme de persistance selon une situation et savoir utiliser tous les m√©canismes de persistance c√¥t√© client.


[background-color="#5DADE2"]
== A toi de jouer
Challenge



