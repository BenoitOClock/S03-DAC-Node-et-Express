= JavaScrit
include::./../adoc_fragments/fragment_header.adoc[]

Module 05 - Les modules JavaScript

ifeval::["{formateur}" ==  "yes"]
[NOTE.speaker]
.Discours formateur
****
Bienvenue dans ce module traitant des modules JavaScript.
****
endif::[]

== Objectifs
* Savoir bien organiser son code

== Pourquoi organiser son code ?

* Rend le code plus lisible
* Facilite la maintenance
* Facilite l'√©volutivit√©
* R√©duit la dette technique

== D'ailleurs, depuis le d√©but de la formation, on essaie de s√©parer les concepts :

* Par exemple : HTML d'un c√¥t√©, CSS de l'autre
* Idem pour PHP, on a essay√© de s√©parer la pr√©paration des donn√©es et g√©n√©ration du HTML dans les templates.

== Or, jusqu'√† pr√©sent lors cette saison :

On a certes cod√© directement dans des fichiers d√©di√©s JS, mais on a utilis√© des fonctions "libres" (non regroup√©es) et notre code n'est pas vraiment rang√© üò¢

== Comment s'organiser en JS ?

* D√©couper en plusieurs fichiers, on l'a d√©j√† mis en place en essayant de faire un fichier par fonctionnalit√© ‚úÇÔ∏è
* Pour aller plus loin, on va regrouper nos fonctions dans des "modules" :
    ** un *module* est un regroupement de fonctions dans lequel on peut √©galement d√©clarer des variables appel√©e propri√©t√©s
    ** pr√©cision, toute fonction appartenant √† un "module" s'appelle une m√©thode
    ** en r√©alit√©, un *module* est un objet (concept abord√© en S04)

== Mise en module de l'affichage d'un message d'erreur 1/4

On reprend ce qui a √©t√© fait en atelier pour afficher un message d'erreur "Vous devez √™tre connect√©..." lorsque l'on clique sur l'ic√¥ne ‚ù§Ô∏è de mise en favoris d'une annonce.

== Mise en module de l'affichage d'un message d'erreur 2/4

Cr√©ation du module *messages* dans un fichier messages.js

[source,javascript]
----
// Module g√©n√©rique de gestion des messages d'informations
const messages = {

  // M√©thode permettant d'ajouter un message √† l'int√©rieur d'un √©l√©ment
  addMessageToElement: function(messageContent, parentElement) {

    // suppression des anciens messages
    messages.removeOldMessages(parentElement);

    // ajout du nouveau message
    const messageElement = document.createElement('p');
    messageElement.className = 'message';
    messageElement.textContent = messageContent;
    
    // on ajoute le message en premier enfant
    parentElement.prepend(messageElement);
  },

  removeOldMessages: function(parentElement) {

    const oldMessages = parentElement.querySelectorAll('.message');

    for (const oldMessage of oldMessages) {
      // https://developer.mozilla.org/en-US/docs/Web/API/Element/remove
      oldMessage.remove();
    }
  }
};





----

== Mise en module de l'affichage d'un message d'erreur 3/4

Cr√©ation d'un second module *destinations* dans un fichier destinations.js

* Objevtif : g√©rer le bouton like d'ajout √† sa liste de destinations favorites
* ‚ö†Ô∏è Nouveaut√© : Utilisation du init() au DOMContentLoaded

== Mise en module de l'affichage d'un message d'erreur 4/4

[source,javascript]
----
// Module de gestion des actions possibles pour les destinations
const destinations = {

    // un module est un objet, il peut aussi contenir des propri√©t√©s
    notLoggedInUserMessage: 'Vous devez √™tre connect√© pour g√©rer vos favoris',

    // m√©thode permettant d'initialiser le module destination,
    // souvent la m√©thode init() sert √† ajouter des √©couteurs d'√©v√®nement
    init: function() {
        destinations.addLikeEvents();
    },

    // m√©thode permettant d'√©couter les clics sur les boutons like    
    addLikeEvents: function () {

        // on r√©cup√®re l'ensemble des boutons like
        const heartElements = document.querySelectorAll('.btn__like');

        // sur chaque bouton like, on √©coute le clic
        for (const heartElement of heartElements) {
            heartElement.addEventListener('click', destinations.handleLikeClick);
        }

    },

    // cr√©ation d'une erreur dans la carte la plus proche
    handleLikeClick: function (event) {
        // event.target r√©cup√®re l'√©l√©ment sur lequel l'√©v√®nement a eu lieu
        // => le bouton like
        // .closest('.card') r√©cup√®re le premier anc√™tre poss√©dant la classe 'card'
        const destElement = event.target.closest('.card');

        // on fait appelle au module messages pour ajouter notre message d'information
        messages.addMessageToElement(destinations.notLoggedInUserMessage, destElement);
    }
};

// En appelant la m√©thode init() une fois le DOM charg√©, cela permettra notamment d'ajouter les √©couteurs
// d'√©v√®nement sur les boutons like :heart: de chaque destination
document.addEventListener('DOMContentLoaded', destinations.init);





----
== Module slider 1/2

Autre exemple : Mise en module de la fonction generateSliderImages cr√©√©e en E02.

== Module slider 2/2

[source,javascript]
----
const slider = {
    
    // On cr√©e un tableau qui contiendra toutes les images du slider
    // Chaque image est identifi√©e par son index.
    sliderImages: [],

    // Sert √† stocker le nombre d'images du slider
    sliderImagesNumber: 0,

    // On d√©finit une variable qui contiendra l'index de l'image courante,
    // par d√©faut, c'est la premi√®re donc 0.
    currentPosition: 0,

    // La m√©thode init permet d'initialiser les propri√©t√©s du "module" slider
    // et d'ajouter les √©couteurs d'√©v√®nement
    init: function() {
        
        // On g√©n√®re les images du slider avec la fonction cr√©√©e pr√©c√©demment 
        slider.generateSliderImages();

        // On r√©cup√®re toutes les slides de la page et on les stocke dans la propri√©t√© sliderImages pour pouvoir les r√©utiliser. 
        slider.sliderImages = document.querySelectorAll('.slider__img');

        // On stocke le nombre d'images du slider pour ne pas avoir √† le recalculer plusieurs fois
        slider.sliderImagesNumber = slider.sliderImages.length;

        // On ajoute les √©couteurs d'√©v√®nement
        slider.addEvents();
    },
    
    // La m√©thode addEvents permet d'ajouter tous les √©couteurs d'√©v√®nements associ√©s au slider
    addEvents: function() {

        // On r√©cup√®re les boutons pr√©c√©dent et suivant
        const sliderButtons = document.querySelectorAll('.slider__btn');

        // On place un √©couteur d'√©v√©nement sur le bouton pr√©c√©dent
        const previousSliderButton = sliderButtons[0];
        previousSliderButton.addEventListener('click', slider.previousSlide);
    
        // On place un √©couteur d'√©v√©nement sur le bouton suivant
        const nextSliderButton = sliderButtons[1];
        nextSliderButton.addEventListener('click', slider.nextSlide);
         
    },
    
    // La fonction previousSlide est appel√©e
    // lorsqu'on clique sur le bouton pr√©c√©dent.
    // Elle permet de calculer la nouvelle position de l'image courante
    // et de l'afficher.
    previousSlide: function() {

        // On d√©termine la nouvelle position de la slide
        // en diminuant le compteur de 1.
        let newPosition = slider.currentPosition - 1;

        // Si la nouvelle position est inf√©rieure √† 0,
        // c'est qu'on est arriv√©s √† la premi√®re image.
        // On le place alors sur la derni√®re pour faire boucler le slider.
        if (newPosition < 0) {
            // On d√©finit la nouvelle position comme √©tant
            // le nombre de slides moins une (car les index commencent √† 0)
            newPosition = slider.sliderImagesNumber - 1;
        }

        // On appelle la fonction qui va modifier l'image courante
        // en lui passant la position de la nouvelle slide √† afficher.
        slider.goToSlide(newPosition);
    },

    // La fonction nextSlide est appel√©e
    // lorsqu'on clique sur le bouton suivant.
    // Elle permet de calculer la nouvelle position de l'image courante et de l'afficher.
    nextSlide: function() {

        // On d√©termine la nouvelle position de la slide en augmentant le compteur de 1
        let newPosition = slider.currentPosition + 1;

        // Si la nouvelle position est sup√©rieure au nombre d'images,
        // c'est qu'on est arriv√©s √† la derni√®re image.
        // On le place alors sur la premi√®re pour faire boucler le slider.
        if (newPosition > slider.sliderImagesNumber - 1) {
            // On d√©finit la nouvelle position comme √©tant 0
            newPosition = 0;
        }

        // On appelle la fonction qui va modifier l'image courante
        // en lui passant la position de la nouvelle slide √† afficher.
        slider.goToSlide(newPosition);
    },


    // Fonction qui permet de changer l'image courante en fonction
    // de la nouvelle position re√ßue en argument.
    // newPosition = l'index de l'image qu'on veut afficher dans le tableau.
    goToSlide: function(newPosition) {

        // On v√©rifie que la nouvelle image √† afficher existe
        if (newPosition >= 0 && newPosition < slider.sliderImagesNumber) {

            // On r√©cup√®re l'image actuellement affich√©e
            const currentSliderImage = document.querySelector('.slider__img--current');

            // /!\ Pour √©viter toute erreur Javascript, avant d'enlever l'image courant,
            // on v√©rifie qu'elle existe car si l'utilisateur modifie le code HTML,
            // il se peut qu'on ne trouve pas d'image avec la classe slider__img--current,
            // et dans ce cas currentSliderImage vaudrait null
            // et le classList.remove() provoquerait une erreur dans notre script
            if (currentSliderImage) {
                currentSliderImage.classList.remove('slider__img--current');    
            } else {
                console.warn('Il n\'y avait aucun slide affich√© dans le diaporama');
            }

            // On r√©cup√®re l'√©l√©ment correspond √† la nouvelle image √† afficher
            const newSliderImage = slider.sliderImages[newPosition];

            // On lui ajoute la classe pour l'afficher dans le slider
            newSliderImage.classList.add('slider__img--current');

            // On met √† jour la position courante
            slider.currentPosition = newPosition;

        } else {
            console.warn('Le slide √† afficher n\'existe pas');
        }
    }
};

// Maintenant que le code est dans un "module" (objet), il ne faut pas oublier
// de l'initialiser pour que les interactions soient activ√©es.
document.addEventListener('DOMContentLoaded', slider.init);
----

== Conclusion

* Vous savez ce qu'est un module.
* Vous avez compris l'int√©r√™t d'avoir un code bien organis√©.
* Vous savez utilis√© les modules.

== Objectif / Niveau

* *Essentiel* : Comprendre l'int√©r√™t d'avoir un code organis√© avec des modules.
* *Attendu* : Savoir utilis√© les modules.
* *Avanc√©* : Vous avez le reflexe de toujours utiliser les modules lorsque cela est n√©cessaire.

[background-color="#5DADE2"]
== A toi de jouer
Challenge